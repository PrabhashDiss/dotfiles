#!/usr/bin/env bash
# Script source: https://github.com/BreadOnPenguins/scripts/blob/master/shortcuts-menus/txtcliphist

histfile="$HOME/.cache/cliphist"
placeholder="<NEWLINE>"

highlight() {
  clip=$(xclip -o -selection primary | xclip -i -f -selection clipboard 2>/dev/null) ;}

output() {
  clip=$(xclip -i -f -selection clipboard 2>/dev/null) ;}

write() {
  if [ ! -f "$histfile" ]; then
    mkdir -p "$(dirname "$histfile")"
    touch "$histfile"
    notify-send "Creating $histfile"
  fi
  [ -z "$clip" ] && exit 0
  multiline=$(printf '%s' "$clip" | sed ':a;N;$!ba;s/\n/'"$placeholder"'/g')
  grep -Fxq "$multiline" "$histfile" || printf '%s\n' "$multiline" >> "$histfile"
  notification="$multiline" ;}

sel() {
  [ -f "$histfile" ] || touch "$histfile"
  selection=$(tac "$histfile" | dmenu -b -l 5 -i -p "Clipboard history:")
  [ -n "$selection" ] && printf '%s\n' "$selection" | sed "s/$placeholder/\n/g" | xclip -i -selection clipboard && notification="Copied to clipboard!" ;}
case "$1" in
  add) highlight && write ;;
  out) output && write ;;
  sel) sel ;;
  *) printf '%s | File: %s\n\nadd - copies primary selection to clipboard, and adds to history file\nout - pipe commands to copy output to clipboard, and add to history file\nsel - select from history file with dmenu and recopy!\n' "$0" "$histfile" ; exit 0 ;;
esac

[ -z "$notification" ] || notify-send "$notification"
